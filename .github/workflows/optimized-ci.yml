name: Optimized CI/CD Pipeline

# Environment-specific triggers
on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'package*.json'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        type: choice
        options:
        - development
        - staging
        - production
        default: 'development'
      use_cache:
        description: 'Use caching'
        type: boolean
        default: true

# Global environment variables
env:
  NODE_VERSION: '18'

jobs:
  # JOB 1: Setup and Environment Detection
  setup:
    name: 🔧 Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Determine Environment
      id: env
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          ENV="${{ github.event.inputs.environment }}"
        elif [ "${{ github.ref_name }}" == "main" ]; then
          ENV="production"
        elif [ "${{ github.ref_name }}" == "develop" ]; then
          ENV="staging"  
        else
          ENV="development"
        fi
        echo "environment=${ENV}" >> $GITHUB_OUTPUT
        echo "🌍 Environment: ${ENV}"

  # JOB 2: Parallel Testing and Linting
  quality-checks:
    name: 🔍 Quality Checks
    runs-on: ubuntu-latest
    needs: setup
    
    strategy:
      matrix:
        check: [test, lint, coverage]
        
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install Dependencies
      run: |
        echo "📦 Installing dependencies for ${{ matrix.check }}..."
        npm ci
        
    - name: Verify Jest Installation
      if: matrix.check == 'test' || matrix.check == 'coverage'
      run: |
        echo "🔍 Verifying Jest installation..."
        npx jest --version
        echo "✅ Jest is available"
        
    - name: Run Tests
      if: matrix.check == 'test'
      run: |
        echo "🧪 Running tests..."
        npm test
        
    - name: Run Linting
      if: matrix.check == 'lint'
      run: |
        echo "🔍 Running linter..."
        npm run lint
        
    - name: Generate Coverage
      if: matrix.check == 'coverage'
      run: |
        echo "📊 Generating test coverage..."
        npm run test:coverage
        
    - name: Upload Coverage
      if: matrix.check == 'coverage'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 7

  # JOB 3: Optimized Build
  build:
    name: 🏗️ Build
    runs-on: ubuntu-latest
    needs: [setup, quality-checks]
    outputs:
      build-time: ${{ steps.build.outputs.build-time }}
      build-size: ${{ steps.build.outputs.build-size }}
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install Dependencies
      run: |
        echo "📦 Installing dependencies for build..."
        npm ci
        
    - name: Set Build Environment
      run: |
        echo "BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
        echo "COMMIT_SHA=${{ github.sha }}" >> $GITHUB_ENV
        echo "NODE_ENV=${{ needs.setup.outputs.environment }}" >> $GITHUB_ENV
        
    - name: Execute Build
      id: build
      run: |
        START_TIME=$(date +%s)
        echo "🏗️ Building application for ${{ needs.setup.outputs.environment }}..."
        npm run build
        END_TIME=$(date +%s)
        BUILD_TIME=$((END_TIME - START_TIME))
        BUILD_SIZE=$(du -sh dist/ | cut -f1)
        echo "build-time=${BUILD_TIME}" >> $GITHUB_OUTPUT
        echo "build-size=${BUILD_SIZE}" >> $GITHUB_OUTPUT
        echo "⏱️ Build completed in ${BUILD_TIME} seconds"
        echo "📦 Build size: ${BUILD_SIZE}"
        
    - name: Create Build Info
      run: |
        cat > dist/build-info.json << EOF
        {
          "version": "2.0.0",
          "environment": "${{ needs.setup.outputs.environment }}",
          "buildTime": "${BUILD_TIME}",
          "commit": "${COMMIT_SHA}",
          "buildDuration": "${{ steps.build.outputs.build-time }}",
          "buildSize": "${{ steps.build.outputs.build-size }}"
        }
        EOF
        echo "📄 Build info created"
        cat dist/build-info.json
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ needs.setup.outputs.environment }}-${{ github.run_number }}
        path: |
          dist/
          package.json
        retention-days: 30

  # JOB 4: Environment-Specific Deployment
  deploy:
    name: 🚀 Deploy
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: needs.setup.outputs.environment != 'development'
    
    environment:
      name: ${{ needs.setup.outputs.environment }}
      
    steps:
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-${{ needs.setup.outputs.environment }}-${{ github.run_number }}
        path: ./deploy/
        
    - name: Deploy to Environment
      run: |
        ENV="${{ needs.setup.outputs.environment }}"
        echo "🚀 Deploying to ${ENV}..."
        
        case $ENV in
          "production")
            echo "🏭 Production deployment with safety checks"
            sleep 3
            ;;
          "staging")
            echo "🧪 Staging deployment"
            sleep 2
            ;;
        esac
        
        echo "✅ Deployment to ${ENV} completed!"
        
    - name: Verify Deployment
      run: |
        echo "🏥 Running deployment verification..."
        if [ -f "./deploy/build-info.json" ]; then
          echo "📄 Build info:"
          cat ./deploy/build-info.json
        fi
        echo "✅ Deployment verified successfully!"

  # JOB 5: Performance Summary
  summary:
    name: 📊 Performance Summary
    runs-on: ubuntu-latest
    needs: [setup, quality-checks, build, deploy]
    if: always()
    
    steps:
    - name: Calculate Performance Metrics
      run: |
        echo "📊 PERFORMANCE SUMMARY"
        echo "======================"
        echo "Environment: ${{ needs.setup.outputs.environment }}"
        echo "Build time: ${{ needs.build.outputs.build-time }}s"
        echo "Build size: ${{ needs.build.outputs.build-size }}"
        echo ""
        echo "🎯 JOB STATUS:"
        echo "- Setup: ${{ needs.setup.result }}"
        echo "- Quality Checks: ${{ needs.quality-checks.result }}"
        echo "- Build: ${{ needs.build.result }}"
        echo "- Deploy: ${{ needs.deploy.result }}"
        echo ""
        
        # Performance recommendations
        BUILD_TIME="${{ needs.build.outputs.build-time }}"
        
        echo "💡 RECOMMENDATIONS:"
        if [ "${BUILD_TIME:-60}" -lt 10 ]; then
          echo "✅ Build time is excellent"
        else
          echo "⚠️ Consider build optimization strategies"
        fi
        
        # Overall status
        if [ "${{ needs.quality-checks.result }}" == "success" ] && [ "${{ needs.build.result }}" == "success" ]; then
          echo "🎉 Pipeline completed successfully!"
        else
          echo "⚠️ Some stages had issues - check individual job logs"
        fi